# Lambda-Cron-S3-Image

This example creates:
- an S3 bucket
- a Cloudwatch namespace
- a lambda function that executes a cron scheduled event to download an image and upload it to the bucket
- associated IAM

# Variables

Set:
- local OS build env variable IMAGE_BUCKET
- image_url in lambda-handler.py
- (OPTIONAL) change image capture frequency from every 2 minutes to something else


## Build

To build this app, you need to be in this example's root folder. Then run the following (instructions for fresh Ubuntu, has python3 and git pre-installed):

```bash
$ sudo apt install unzip
$ curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
$ unzip awscliv2.zip
$ sudo ./aws/install
$ aws configure # paste access key, secret key, region
$ sudo apt install python3-pip
$ sudo apt install python3.10-venv
$ python3 -m venv .env
$ source .env/bin/activate
$ pip install -r requirements.txt
```

This will install the necessary CDK, then this example's dependencies, and then build your Python files and your CloudFormation template.

Install the latest version of the AWS CDK CLI:

```shell
$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
$ source ~/.bashrc
$ nvm install --lts
$ npm i -g aws-cdk
```

## Deploy

First bootstrap cdk:
```shell
$ export IMAGE_BUCKET=chosenbucketnameidentifier
$ cdk bootstrap aws://$(aws sts get-caller-identity --query Account --output text)/$(aws configure get default.region)
```

Run `cdk deploy`. This will deploy / redeploy your Stack to your AWS Account.

After the deployment you will see the API's URL, which represents the url you can then use.

Reminder: returning after a while to develop again, you will need to run source, export and bootstrap commands again.

## Synthesize Cloudformation Template

To see the Cloudformation template generated by the CDK, run `cdk synth`, then check the output file in the "cdk.out" directory.

## Teardown

Run `cdk destroy`(specify the stack if you have other resources in your account you don't want accidentally deleted!)

## Future improvements
- tighten Lambda role permissions (temporarily wide to aid development and avoid circular references).
- random bucket name to avoid needing to choose one.
